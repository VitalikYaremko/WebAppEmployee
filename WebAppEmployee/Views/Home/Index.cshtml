@model IEnumerable<WebAppEmployee.Domain.Models.Employee>
<div class="jumbotron">
    <h1>ASP.NET MVC 5 TEST</h1>
</div>
<div id="modDialog" class="modal fade">
    <div id="dialogContent" class="modal-dialog"></div>
</div>
<div class="row">
    <div class="col-md-8">
        <table id="tbl_employee" class="table table-bordered table-striped table-responsive table-hover">
            <thead>
                <tr>
                    <th align="left">Registration Number</th>
                    <th align="left">IsExternal</th>
                    <th align="left">FullName</th>
                    <th align="left">Gender</th>
                    <th align="left">Birthday</th>
                    <th align="left">Position Name</th>
                    <th align="left">Salary</th>
                    <th align="left"></th>
                    <th align="left"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        @Scripts.Render("~/scripts/jquery-3.6.0.min.js")
        @Scripts.Render("~/scripts/jquery.unobtrusive-ajax.min.js")
    </div>
    <div class="col-md-4">
        <button id="button">Import Employees</button>
        <input id="file-input" type="file" name="name" onselect="importEmployees()" accept=".json" style="display: none;" />
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1" role="dialog" aria-labelledby="employeeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="employeeModalLabel">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label class="col-form-label">Registration Number:</label>
                        <input type="text" class="form-control" id="registration-number" disabled>
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">IsExternalEmployee:</label>
                        <input type="text" class="form-control" id="is-external-employee">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">FullName:</label>
                        <input type="text" class="form-control" id="full-name">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Gender:</label>
                        <input type="text" class="form-control" id="gender">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Birthday:</label>
                        <input type="text" class="form-control" id="birthday">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Position:</label>
                        <input type="text" class="form-control" id="position">
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">Salary:</label>
                        <input type="text" class="form-control" id="salary">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" Onclick='updateEmployee()'>Save changes</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    $(document).ready(function () {
        loadData();
    });

    $('#button').on('click', function () {
        $('#file-input').trigger('click');
    });

    $('#file-input').bind("change", function () {
        var formData = new FormData();
        formData.append('file', $('#file-input')[0].files[0]);

        $.ajax({
            type: 'POST',
            url: '/api/employee/import',
            data: formData,
            processData: false,  // tell jQuery not to process the data
            contentType: false,  // tell jQuery not to set contentType
            success: function (data) {
                alert(data);
            }
        });
    });


    function loadData() {
        //need to move to service
        $("#tbl_employee tbody tr").remove();
        $.ajax({
            type: 'GET',
            url: '/api/employee',
            dataType: 'json',
            success: function (data) {
                $.each(data, function (i, item) {
                    var rows = "<tr>"
                        + `<td>${item.RegistrationNumber}</td>`
                        + `<td>${item.IsExternalEmployee}</td>`
                        + `<td>${item.FullName}</td>`
                        + `<td>${item.Gender}</td>`
                        + `<td>${item.Birthday}</td>`
                        + `<td>${item.Position?.Name}</td>`
                        + `<td>${item.Position?.BaseSalary}</td>`
                        + `<td><button Onclick='edit(${item.RegistrationNumber},${item.IsExternalEmployee})'>Edit</button></td>`
                        + `<td><button Onclick='deleteEmployee(${item.RegistrationNumber},${item.IsExternalEmployee})'>Delete</button></td>`
                        + "</tr>";
                    $('#tbl_employee tbody').append(rows);
                });
            },
            error: function (ex) {

            }
        });
        return false;
    }

    function getEmployee(registrationNumber) {
        //need to move to service
        return $.ajax({
            type: 'GET',
            url: `/api/employee/${registrationNumber}`,
            dataType: 'json',
            success: function (data) {
                return data;
            },
            error: function (ex) {

            }
        });
    }

   async function edit(registrationNumber) {
        let item = await getEmployee(registrationNumber);
        fillModal(item);
        $('#employeeModal').modal('show');
    }

    function fillModal(item) {
        $('#registration-number').val(item.RegistrationNumber);
        $('#is-external-employee').val(item.IsExternalEmployee);
        $('#full-name').val(item.FullName);
        $('#gender').val(item.Gender);
        $('#birthday').val(item.Birthday);
        $('#position').val(item.Position?.Name);
        $('#salary').val(item.Position?.BaseSalary);
    }

    function getModelFromModalWindow() {
        return {
            registrationNumber: $('#registration-number').val(),
            isExternalEmployee: $('#is-external-employee').val(),
            fullName: $('#full-name').val(),
            gender: $('#gender').val(),
            birthday: $('#birthday').val(),
            positionName: $('#position').val(),
            baseSalary: $('#salary').val()
        }
    }

    function updateEmployee() {
        let item = getModelFromModalWindow();

        return $.ajax({
            type: 'PUT',
            url: `/api/employee`,
            dataType: 'json',
            data: item,
            success: function (data) {
                $('#employeeModal').modal('hide');
                loadData();
            },
            error: function (ex) {

            }
        });

       
    }

    function deleteEmployee(registrationNumber) {
        //need to move to service
        $.ajax({
            type: 'DELETE',
            url: `/api/employee?registrationNumber=${registrationNumber}`,
            success: function () {
                loadData();
            },
            error: function (ex) {

            }
        });
    }
</script>